# =========================================================
# MyIPDNS API Nginx Configuration
# =========================================================

# 1. 定义限流区域 (Rate Limiting Zones)
# 针对直连 IP 的限流：每秒 20 个请求，存储区 10MB
limit_req_zone $binary_remote_addr zone=api_direct_limit:10m rate=20r/s;

# (可选) 针对 CDN 来源的限流：可以更宽松，或者不限
# 因为 CF 已经挡了一层，这里主要是防止 CF 回源时被打穿
limit_req_zone $binary_remote_addr zone=api_cdn_limit:10m rate=100r/s;

# 定义上游 Go 服务地址
upstream myip_go_backend {
    server 127.0.0.1:8080;
    keepalive 64; # 保持长连接，提升性能
}

# --- Server Block 1: 默认服务器 (拒绝直接 IP 访问) ---
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;
    
    # 直接关闭连接，不返回任何数据 (最省资源)
    return 444;
}

# --- Server Block 2: 直连域名 (v4.api... / v6.api...) ---
server {
    listen 80;
    listen [::]:80;
    server_name v4.api.myipdns.com v6.api.myipdns.com apiv4.myipdns.com apiv6.myipdns.com;

    # 日志优化：高并发下可以暂时关闭访问日志以减少 I/O
    # access_log off; 

    location / {
        # === 核心防护 ===
        # 应用 20r/s 限流，允许突发 50 个
        limit_req zone=api_direct_limit burst=50 nodelay;

        # 代理设置
        proxy_pass http://myip_go_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection ""; # 启用 Keep-Alive
        
        # 传递真实 Host，让 Go 识别这是直连模式
        proxy_set_header Host $host;
        
        # 传递真实 IP
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}

# --- Server Block 3: 主域名 (走 Cloudflare CDN) ---
server {
    listen 80;
    listen [::]:80;
    server_name api.myipdns.com;

    # 获取 Cloudflare 真实 IP (需要 Nginx 安装 realip 模块，Debian 默认自带)
    # 这里填写 CF 的 IP 段，或者直接信任所有 (如果本机只有 CF 能连)
    # set_real_ip_from 103.21.244.0/22; # ... (CF IP 列表太长，建议用脚本自动更新)
    # real_ip_header CF-Connecting-IP;

    location / {
        # 宽松限流
        limit_req zone=api_cdn_limit burst=200 nodelay;

        proxy_pass http://myip_go_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # 传递 Host，让 Go 识别这是 CDN 模式
        proxy_set_header Host $host;
        
        # 重点：传递 CF 的 Header 给 Go
        proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
        proxy_set_header CF-IPCountry $http_cf_ipcountry;
        
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}